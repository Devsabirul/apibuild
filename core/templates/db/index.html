{% extends "base/base.html" %}
{% load static %}
{% block title %}Create Database{% endblock title %}
{% block body %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div id="createTable">
                <div id="button">
                    <span>üìù</span> Create Table
                </div>

                <div id="createtabelcontainer">
                    <form action="" method="post" id="my-form">
                        {% csrf_token %}
                        <div class="d-flex">
                            <div class="tablename">
                                <label for="tablename" style="font-size: 15px;color: #424242;">Name:</label>
                                <input class="" id="tablename" type="text" name="tablename"
                                    style="outline: none;width: 15em;margin-left: 5px;">
                            </div>
                            <div class="colnum" style="margin-left: 25px;">
                                <label for="colnum" style="font-size: 15px;color: #424242;">Number of columns:</label>
                                <input class="" value="0" id="row-count" type="number" name="colnum"
                                    style="outline: none;width: 15em;margin-left: 5px;" disabled>
                            </div>
                            <div class="createdbutton">
                                <button type="submit" class="btn btn-outline-secondary btn-sm"
                                    style="margin-left: 5px;">Create</button>
                            </div>
                        </div>
                        <div class="removescrollbar" style="display: block;overflow-x: scroll;margin-bottom: 5px;">
                            <table class="table table-sm mt-4" id="dynamic-table">
                                <thead>
                                    <tr>
                                        <td scope="col">Field Name</td>
                                        <td scope="col">Type</td>
                                        <td scope="col">Length/Values</td>
                                        <td scope="col">Default</td>
                                        <td scope="col">Null</td>
                                        <td scope="col">Blank</td>
                                        <td scope="col">Action</td>
                                        <td scope="col">Action</td>
                                        <td scope="col">Action</td>
                                        <td scope="col">Action</td>
                                        <td scope="col">Action</td>
                                        <td scope="col">Action</td>
                                    </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                        </div>

                    </form>
                    <div class="addrow">
                        <button class="btn btn-secondary btn-sm" style="margin-left: 5px;" id="add-row">Add
                            Field</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
    // Function to add a new row
    function addRow() {
        // Get a reference to the table and tbody
        const table = document.getElementById('dynamic-table');
        const tbody = table.querySelector('tbody');

        // Create a new row
        const newRow = document.createElement('tr');

        // Create and append cells with the specified content
        const cell1 = document.createElement('td');
        cell1.innerHTML = '<input type="text" id="fieldname">';
        newRow.appendChild(cell1);

        const cell2 = document.createElement('td');
        cell2.innerHTML = `
        <select style="padding: 3px !important; width: 115px;" id="type">
            <option value="AutoField">AutoField</option>
            <option value="BigAutoField">BigAutoField</option>
            <option value="BinaryField">BinaryField</option>
            <option value="BooleanField">BooleanField</option>
            <option value="CharField">CharField</option>
            <option value="DateField">DateField</option>
            <option value="DateTimeField">DateTimeField</option>
            <option value="DecimalField">DecimalField</option>
            <option value="DurationField">DurationField</option>
            <option value="EmailField">EmailField</option>
            <option value="FileField">FileField</option>
            <option value="FilePathField">FilePathField</option>
            <option value="FloatField">FloatField</option>
            <option value="ImageField">ImageField</option>
            <option value="IntegerField">IntegerField</option>
            <option value="GenericIPAddressField">GenericIPAddressField</option>
            <option value="NullBooleanField">NullBooleanField</option>
            <option value="PositiveIntegerField">PositiveIntegerField</option>    
            <option value="TextField">TextField</option>
            <option value="URLField">URLField</option>
            <option value="UUIDField">UUIDField</option>
            <option value="ForeignKey">ForeignKey</option>
            <option value="ManyToManyField">ManyToManyField</option>
            <option value="OneToOneField">OneToOneField</option>
            <option value="ArrayField">ArrayField</option>
            <option value="JSONField">JSONField</option>
            <option value="HStoreField">HStoreField</option>
            <option value="BinaryJSONField">BinaryJSONField</option>        
            <option value="PositiveBigIntegerField">PositiveBigIntegerField</option>
            <option value="PositiveSmallIntegerField">PositiveSmallIntegerField</option>
            <option value="SlugField">SlugField</option>
            <option value="SmallAutoField">SmallAutoField</option>
            <option value="BigIntegerField">BigIntegerField</option>
        </select>
      `;
        newRow.appendChild(cell2);

        const cell3 = document.createElement('td');
        cell3.innerHTML = '<input type="number" id="length" style="width: 150px;" value="500">';
        newRow.appendChild(cell3);

        const cell4 = document.createElement('td');
        cell4.innerHTML = '<input type="text" id="default" style="width: 150px;">';
        newRow.appendChild(cell4);

        const cell5 = document.createElement('td');
        cell5.innerHTML = `
        <select style="padding: 3px !important; width: 115px;" id="null">
          <option value="True">True</option>
          <option value="False">False</option>
        </select>
      `;
        newRow.appendChild(cell5);

        const cell6 = document.createElement('td');
        cell6.innerHTML = `
        <select style="padding: 3px !important; width: 115px;" id="blank">
          <option value="True">True</option>
          <option value="False">False</option>
        </select>
      `;
        newRow.appendChild(cell6);

        const cell7 = document.createElement('td');
        const deleteButton = document.createElement('button');
        deleteButton.className = 'btn btn-sm btn-outline-secondary';
        deleteButton.style.fontWeight = 'bold';
        deleteButton.style.width = '50px';
        deleteButton.textContent = 'X';

        // Add a click event listener to remove the row when the button is clicked
        deleteButton.addEventListener('click', function () {
            tbody.removeChild(newRow); // Remove the row when the button is clicked
            updateRowCount();
        });

        cell7.appendChild(deleteButton);
        newRow.appendChild(cell7);

        // Append the new row to the tbody
        tbody.appendChild(newRow);
        updateRowCount();
    }
    // Function to update the row count
    function updateRowCount() {
        const rowCount = document.querySelectorAll('#dynamic-table tbody tr').length;
        document.getElementById('row-count').value = rowCount;
    }
    // Function to get all input values as an array

    function getAllData() {
        // Get a reference to the table and tbody
        const table = document.getElementById('dynamic-table');
        const tbody = table.querySelector('tbody');

        // Get all rows in the tbody
        const rows = tbody.querySelectorAll('tr');

        // Initialize an array to store the data
        const data = [];

        // Loop through each row and extract input values
        rows.forEach(function (row) {
            const inputs = row.querySelectorAll('input, select');
            const rowData = {};

            inputs.forEach(function (input) {
                const id = input.id;
                const value = input.value;
                rowData[id] = value;
            });

            data.push(rowData);
        });
        return data;
    }

    // Add an event listener to the "Add Row" button
    const addButton = document.getElementById('add-row');
    addButton.addEventListener('click', addRow);

    // Add an event listener to the form for form submission
    const form = document.getElementById('my-form');
    form.addEventListener('submit', function (event) {
        event.preventDefault(); // Prevent the default form submission
        const allData = getAllData();

        const tablename = document.getElementById('tablename').value;
        let removeSpace = tablename.split(' ').join('')
        let finalTableName = removeSpace.charAt(0).toUpperCase() + removeSpace.slice(1);

        const jsonData = JSON.stringify(allData);
        $.ajax({
            url: '/createtable',
            method: 'POST',
            data: {
                'tablename': finalTableName,
                'fieldArry': jsonData
            },
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function (response) {
                console.log(response);
            },
            error: function (error) {
                console.error(error);
            }
        });
    });

    updateRowCount();



</script>

{% endblock body %}